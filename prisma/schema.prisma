generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PRO_MONTHLY
  PRO_ANNUAL
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum Sex {
  MALE
  FEMALE
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum FoodSource {
  MANUAL
  AI
  BARCODE
  VOICE
}

enum Confidence {
  HIGH
  MEDIUM
  LOW
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String

  // Profile (mirroring iOS UserProfile)
  heightCm        Int?
  weightKg        Int?
  age             Int?
  sex             Sex?
  activityLevel   ActivityLevel?
  tdee            Int?
  budgetCap       Int?
  deficitPercent  Int     @default(20)
  pessimismLevel  String  @default("normal")

  // Additional profile fields from iOS
  weeklyGoal      String?  // "lose_0.5", "lose_0.25", "maintain"
  chargeRate      Float?   // 0.25, 0.5, 0.75
  bmrValue        Int?
  baseLimit       Int?
  manualBaseLimit Int?
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastLogDate     String?
  defaultFoodPessimism Boolean @default(false)

  // Subscription
  subscriptionTier   SubscriptionTier   @default(FREE)
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  subscriptionExpiry DateTime?
  subscriptionStartDate DateTime?

  // RevenueCat integration
  revenueCatAppUserId String? @unique

  // Apple Sign In
  appleUserId String? @unique
  displayName String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  foodLogs                FoodLog[]
  usageRecords            UsageRecord[]
  refreshTokens           RefreshToken[]
  pushTokens              PushToken[]
  notificationPreferences UserNotificationPreference?
  notificationLogs        NotificationLog[]

  @@index([email])
  @@index([revenueCatAppUserId])
  @@index([appleUserId])
}

model FoodLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  calories     Int
  baseCalories Int?        // Original calories before pessimism
  description  String
  imageUrl     String?
  isGreasy     Boolean     @default(false)
  source       FoodSource
  confidence   Confidence?

  // Macronutrients (in grams)
  protein Int?
  carbs   Int?
  fat     Int?

  // Detailed items from AI analysis
  items Json?
  notes String?

  // Date tracking (matches iOS format "YYYY-MM-DD")
  date      String
  createdAt DateTime @default(now())

  @@index([userId, date])
  @@index([userId, createdAt])
}

model UsageRecord {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date       String
  scanCount  Int       @default(0)
  lastScanAt DateTime?

  @@unique([userId, date])
  @@index([userId, date])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  lastLoginAt  DateTime?

  @@index([email])
}

// ============================================
// Push Notification Models
// ============================================

enum NotificationType {
  MEAL_REMINDER
  DAILY_SUMMARY
  STREAK_MILESTONE
  STREAK_AT_RISK
  ADMIN_BROADCAST    // Admin-sent bulk notifications
}

enum DevicePlatform {
  IOS
  ANDROID
}

enum BroadcastStatus {
  DRAFT
  QUEUED
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

model PushToken {
  id         String         @id @default(cuid())
  userId     String
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String         @unique
  platform   DevicePlatform
  deviceId   String?
  isActive   Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  lastUsedAt DateTime?

  @@index([userId])
  @@index([token])
  @@index([isActive, platform])
}

model UserNotificationPreference {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Master toggle
  notificationsEnabled   Boolean  @default(true)

  // Meal Reminders
  mealRemindersEnabled   Boolean  @default(false)
  breakfastTime          String?  // "HH:mm" format
  lunchTime              String?
  dinnerTime             String?
  breakfastEnabled       Boolean  @default(true)
  lunchEnabled           Boolean  @default(true)
  dinnerEnabled          Boolean  @default(true)

  // Daily Summary
  dailySummaryEnabled    Boolean  @default(false)
  dailySummaryTime       String?  // "21:00" default

  // Streak Alerts
  streakAlertsEnabled    Boolean  @default(true)
  streakMilestoneEnabled Boolean  @default(true)
  streakAtRiskEnabled    Boolean  @default(true)
  streakAtRiskTime       String?  // "20:00" default

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userId])
}

model NotificationLog {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  body          String
  data          Json?
  sentAt        DateTime?
  deliveredAt   DateTime?
  failedAt      DateTime?
  failureReason String?
  apnsId        String?
  broadcastId   String?          // Link to BroadcastCampaign if from admin
  broadcast     BroadcastCampaign? @relation(fields: [broadcastId], references: [id])
  createdAt     DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([type, sentAt])
  @@index([broadcastId])
}

// Admin broadcast campaign for bulk notifications
model BroadcastCampaign {
  id              String          @id @default(cuid())
  title           String          // Internal title for admin reference
  notificationTitle String        // Title shown in the notification
  notificationBody  String        // Body text of the notification
  data            Json?           // Optional custom data payload

  // Targeting
  targetTiers     String[]        // ["FREE", "PRO_MONTHLY", etc.] - empty means all
  targetPlatforms String[]        // ["IOS", "ANDROID"] - empty means all

  // Status tracking
  status          BroadcastStatus @default(DRAFT)
  scheduledFor    DateTime?       // For scheduled sends
  startedAt       DateTime?
  completedAt     DateTime?

  // Progress tracking
  totalRecipients Int             @default(0)
  sentCount       Int             @default(0)
  failedCount     Int             @default(0)

  // Metadata
  createdBy       String?         // Admin email who created it
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  logs            NotificationLog[]

  @@index([status])
  @@index([createdAt])
}

